<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Калькулятор TIP</title>
  <style>
    body { font-family: sans-serif; background: none; padding: 20px; }
    h1 { color: #1156F3; text-align: center; margin-top: -10px; }
    .form-group { margin-bottom: 10px; }
    label { margin-right: 8px; }
    input[type="date"], input[type="number"]{
      padding: 5px; font-size: 1em; margin-right: 10px;
      border: 1px solid #ccc; border-radius: 4px;
    }
    input[type="number"] { width: 120px; }
    .btn{
      cursor: pointer; background-color: #1fb1fd; color: white;
      border: none; padding: 5px 10px; border-radius: 4px;
      margin-right: 10px; margin-top: 5px;
    }
    .btn:hover{ background-color: #2196F3; }
    .out{
      width: 100%; padding: 10px; font-size: 1em;
      border: 1px solid #ccc; border-radius: 4px; background: #fff;
      line-height: 1.5;
    }
    .row { display: flex; flex-wrap: wrap; gap: 10px; align-items: center; }
    .muted { color: #666; }
    .ok { color: #1a7f37; font-weight: 600; }
    .warn { color: #b54708; font-weight: 600; }
    .bad { color: #b42318; font-weight: 600; }
  </style>
</head>
<body>

<h1>Калькулятор TIP <br> недели и прогресс</h1>

<div class="form-group row">
  <label for="startDate">Дата выдачи сертификата:</label>
  <input type="date" id="startDate" />

  <button class="btn" type="button" onclick="setToday()">Сегодня</button>

  <label for="tipHave">TIP уже собрано:</label>
  <input type="number" id="tipHave" placeholder="например 40" min="0" step="0.1" />
</div>

<div class="form-group">
  <div class="out" id="output">
    <span class="muted">Выберите дату и/или введите TIP — расчёт обновится автоматически.</span>
  </div>
</div>

<script>
  const TARGET_TIP = 250;

  const startInput = document.getElementById("startDate");
  const tipInput = document.getElementById("tipHave");
  const out = document.getElementById("output");

  function pad2(n) { return String(n).padStart(2, "0"); }

  function formatDateDMY(date) {
    return `${pad2(date.getDate())}.${pad2(date.getMonth() + 1)}.${date.getFullYear()}`;
  }

  // Надёжный парсинг yyyy-mm-dd без UTC-сдвигов
  function parseYMDLocal(ymd) {
    if (!ymd) return null;
    const m = String(ymd).match(/^(\d{4})-(\d{2})-(\d{2})$/);
    if (!m) return null;
    const y = Number(m[1]), mo = Number(m[2]), d = Number(m[3]);
    const dt = new Date(y, mo - 1, d, 0, 0, 0, 0);
    if (dt.getFullYear() !== y || dt.getMonth() !== (mo - 1) || dt.getDate() !== d) return null;
    return dt;
  }

  function addYearsSafe(dt, years) {
    const res = new Date(dt.getFullYear(), dt.getMonth(), dt.getDate(), 0,0,0,0);
    const m = res.getMonth();
    res.setFullYear(res.getFullYear() + years);
    if (res.getMonth() !== m) res.setDate(0);
    return res;
  }

  function addMonthsSafe(dt, months) {
    const res = new Date(dt.getFullYear(), dt.getMonth(), dt.getDate(), 0,0,0,0);
    const d = res.getDate();
    res.setDate(1);
    res.setMonth(res.getMonth() + months);
    const lastDay = new Date(res.getFullYear(), res.getMonth() + 1, 0).getDate();
    res.setDate(Math.min(d, lastDay));
    return res;
  }

  function clamp(x, a, b) { return Math.max(a, Math.min(b, x)); }

  function fullWeeks7x24Since(start, now) {
    if (!start || !now || now < start) return 0;
    const msPerWeek = 7 * 24 * 60 * 60 * 1000;
    return Math.floor((now - start) / msPerWeek);
  }

  function plannedTipNow(start, now) {
    const expiry = addYearsSafe(start, 5);
    const deadline = addMonthsSafe(expiry, -3);

    if (now <= start) return { planned: 0, progress: 0, expiry, deadline, status: "ещё не началось" };
    if (now >= deadline) return { planned: TARGET_TIP, progress: 1, expiry, deadline, status: "дедлайн наступил (или прошёл)" };

    const total = deadline - start;
    const elapsed = now - start;
    const p = total <= 0 ? 1 : elapsed / total;

    return { planned: TARGET_TIP * p, progress: p, expiry, deadline, status: "в процессе" };
  }

  function setToday() {
    const today = new Date();
    const yyyy = today.getFullYear();
    const mm = pad2(today.getMonth() + 1);
    const dd = pad2(today.getDate());
    startInput.value = `${yyyy}-${mm}-${dd}`;
    recalc();
  }

  function recalc() {
    const start = parseYMDLocal(startInput.value);
    const now = new Date();

    if (!start) {
      out.innerHTML = `<span class="muted">Выберите дату начала.</span>`;
      return;
    }

    const weeks = fullWeeks7x24Since(start, now);
    const info = plannedTipNow(start, now);

    const planned = info.planned;
    const plannedRounded = Math.round(planned * 10) / 10;

    const tipHaveRaw = tipInput.value;
    const tipHave = tipHaveRaw === "" ? null : Number(tipHaveRaw);

    let factLine = `<span class="muted">TIP уже собрано:</span> —`;
    let progressVsPlanLine = `<span class="muted">Прогресс к плану на сегодня:</span> —`;
    let deltaLine = "";

    if (tipHave != null && !Number.isNaN(tipHave)) {
      const denom = planned <= 0 ? 0 : planned;
      const pct = denom === 0 ? (tipHave > 0 ? 100 : 0) : (tipHave / denom) * 100;
      const pctText = denom === 0
        ? (tipHave > 0 ? "100%" : "0%")
        : `${clamp(pct, 0, 999999).toFixed(1)}%`;

      const delta = tipHave - planned;
      const deltaRounded = Math.round(delta * 10) / 10;

      let cls = "ok";
      let label = "опережаете план";
      if (denom === 0 && tipHave === 0) { cls = "muted"; label = "план ещё 0"; }
      else if (deltaRounded < 0) { cls = "bad"; label = "отстаёте от плана"; }

      factLine = `<span class="muted">TIP уже собрано:</span> <b>${tipHave.toLocaleString("ru-RU")}</b>`;
      progressVsPlanLine = `<span class="muted">Прогресс к плану на сегодня:</span> <b>${pctText}</b>`;
      deltaLine = `<span class="${cls}">${label}</span> (разница: <b>${deltaRounded.toLocaleString("ru-RU")}</b> TIP)`;
    }

    const statusExtra =
      (now > info.expiry) ? ' <span class="bad">Сертификат уже истёк.</span>' :
      (now >= info.deadline && now <= info.expiry) ? ' <span class="warn">Дедлайн для 250 TIP уже наступил.</span>' :
      '';

    out.innerHTML = `
      <div><span class="muted">Сегодня:</span> <b>${formatDateDMY(now)}</b></div>
      <div><span class="muted">Дата начала:</span> <b>${formatDateDMY(start)}</b></div>
      <div><span class="muted">Полных недель прошло:</span> <b>${weeks}</b></div>
      <hr style="border:none;border-top:1px solid #eee;margin:10px 0;">
      <div><span class="muted">Окончание сертификата:</span> <b>${formatDateDMY(info.expiry)}</b></div>
      <div><span class="muted">Дедлайн подачи на продление:</span> <b>${formatDateDMY(info.deadline)}</b></div>
      <div><span class="muted">По плану на сегодня должно быть:</span> <b>${plannedRounded.toLocaleString("ru-RU")}</b> TIP <span class="muted">из ${TARGET_TIP}</span></div>
      <div>${factLine}</div>
      <div>${progressVsPlanLine}</div>
      <div>${deltaLine}</div>
      <div><span class="muted">Статус:</span> <b>${info.status}</b>${statusExtra}</div>
    `;
  }

  // Авто-пересчёт (без кнопки)
  startInput.addEventListener("change", recalc);
  tipInput.addEventListener("input", () => {
    clearTimeout(tipInput._t);
    tipInput._t = setTimeout(recalc, 150);
  });

  // чтобы “Сегодня” могло обновиться после полуночи (и план/недели тоже)
  setInterval(() => { if (startInput.value) recalc(); }, 60 * 1000);

</script>
</body>
</html>
